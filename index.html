<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EPUB Reader ‚Äî Offline by You</title>
<!-- epub.js CDN: c·∫ßn internet khi m·ªü l·∫ßn ƒë·∫ßu -->
<script src=".epub.js"></script>
<style>
  :root{
    --bg:#0b1020; --card:#0e162b; --muted:#9aa4b2; --text:#eaf0ff;
    --accent:#38bdf8; --accent2:#22c55e; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1020,#101736);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:rgba(14,22,43,.9);backdrop-filter:blur(6px);z-index:10;
    padding:.6rem .8rem;border-bottom:1px solid #1f2b4a;display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid #2a3a63;background:#152043;color:var(--text);padding:.5rem .8rem;border-radius:.6rem;
    cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{border-color:#3b4f85}
  .btn.primary{border-color:#3aa0ff;background:#16294b}
  .btn.danger{border-color:#ef4444;background:#2a1212}
  input[type="file"]{display:none}
  .chip{padding:.35rem .6rem;border:1px solid #2a3a63;border-radius:999px;font-size:.9rem}
  .grow{flex:1}
  #viewer-wrap{display:grid;grid-template-columns:280px 1fr;gap:.8rem;padding:.8rem;height:calc(100vh - 64px)}
  #toc{background:rgba(14,22,43,.6);border:1px solid #1f2b4a;border-radius:.8rem;overflow:auto;padding:.6rem}
  #toc h3{margin:.2rem .4rem .6rem;color:#a7b4c9;font-size:.95rem}
  #toc a{display:block;color:#cfe3ff;text-decoration:none;padding:.35rem .45rem;border-radius:.4rem}
  #toc a:hover{background:#1a2647}
  #stage{background:rgba(14,22,43,.6);border:1px solid #1f2b4a;border-radius:.8rem;overflow:hidden;position:relative}
  #area{height:100%;width:100%}
  #drop{position:absolute;inset:0;display:none;place-items:center;border:2px dashed #2a3a63;border-radius:.8rem;
    color:#a7b4c9;background:rgba(16,23,54,.6)}
  #controls{display:flex;gap:.5rem;align-items:center}
  #zoom{display:flex;gap:.35rem}
  #status{font-size:.9rem;color:var(--muted)}
  .range{accent-color:var(--accent)}
  @media (max-width:900px){
    #viewer-wrap{grid-template-columns:1fr}
    #toc{height:240px}
  }
</style>
</head>
<body>
<header>
  <label class="btn primary" for="file">üìñ Ch·ªçn EPUB</label>
  <input id="file" type="file" accept=".epub">
  <div id="controls">
    <button id="prev" class="btn">‚üµ Prev</button>
    <button id="next" class="btn">Next ‚ü∂</button>
    <span class="chip">C·ª° ch·ªØ: <input id="font" type="range" min="80" max="160" value="100" class="range">%</span>
    <span id="zoom">
      <button id="zoomOut" class="btn">‚àí</button>
      <span class="chip" id="scaleVal">100%</span>
      <button id="zoomIn" class="btn">+</button>
    </span>
    <span class="chip">Trang: <span id="loc">‚Äî</span></span>
  </div>
  <div class="grow"></div>
  <span id="status">K√©o & th·∫£ file .epub v√†o v√πng ƒë·ªçc</span>
</header>

<div id="viewer-wrap">
  <nav id="toc"><h3>M·ª•c l·ª•c</h3><div id="tocItems"></div></nav>
  <section id="stage">
    <div id="area" tabindex="0"></div>
    <div id="drop"><div style="text-align:center">
      <div style="font-size:2rem; margin-bottom:.4rem">‚¨áÔ∏è Th·∫£ EPUB v√†o ƒë√¢y</div>
      <div>ho·∫∑c d√πng n√∫t ‚ÄúCh·ªçn EPUB‚Äù</div>
    </div></div>
  </section>
</div>

<script>
(() => {
  const fileInput = document.getElementById('file');
  const area = document.getElementById('area');
  const drop = document.getElementById('drop');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const fontRange = document.getElementById('font');
  const scaleVal = document.getElementById('scaleVal');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const loc = document.getElementById('loc');
  const status = document.getElementById('status');
  const tocItems = document.getElementById('tocItems');

  let book = null, rendition = null, currentScale = 1;

  function setStatus(msg){ status.textContent = msg; }

  function clearTOC(){ tocItems.innerHTML = ""; }

  function buildTOC(navs){
    clearTOC();
    function addItems(items){
      items.forEach(it => {
        const a = document.createElement('a');
        a.textContent = it.label.trim() || '(no title)';
        a.href = '#';
        a.addEventListener('click', (e)=>{ e.preventDefault(); rendition.display(it.href); });
        tocItems.appendChild(a);
        if (it.subitems && it.subitems.length) addItems(it.subitems);
      });
    }
    addItems(navs.toc || []);
  }

  function bindRendition(){
    rendition.on('relocated', (e) => {
      loc.textContent = e.location && e.location.start ? (e.location.start.displayed.page + '/' + e.location.start.displayed.total) : '‚Äî';
    });
    rendition.themes.default({ 'body': { 'line-height': '1.6', 'color': '#eaf0ff' } });
    applyFont();
    applyScale();
    area.focus();
  }

  function applyFont(){ if (rendition) rendition.themes.fontSize(fontRange.value + '%'); }
  function applyScale(){
    // Scale the iframe wrapper
    const ifr = area.querySelector('iframe');
    if (ifr) {
      ifr.style.transformOrigin = '0 0';
      ifr.style.transform = 'scale(' + currentScale + ')';
      // ensure container scrolls
      area.style.overflow = 'auto';
      // adjust min-size so scrollbars work
      ifr.style.minWidth = (100/currentScale) + '%';
      ifr.style.minHeight = (100/currentScale) + '%';
    }
    scaleVal.textContent = Math.round(currentScale*100) + '%';
  }

  function unloadBook(){
    if (rendition) { rendition.destroy(); rendition = null; }
    if (book) { book.destroy(); book = null; }
    clearTOC();
    loc.textContent = '‚Äî';
  }

  async function openArrayBuffer(buf){
    unloadBook();
    setStatus('ƒêang m·ªü EPUB‚Ä¶');
    book = ePub(buf);
    rendition = book.renderTo(area, { width: '100%', height: '100%' });
    await rendition.display();
    bindRendition();
    const navs = await book.loaded.navigation;
    buildTOC(navs);
    setStatus('ƒê√£ t·∫£i xong.');
  }

  // File input
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const ab = await f.arrayBuffer();
    openArrayBuffer(ab);
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(t => area.addEventListener(t, (e)=>{ e.preventDefault(); drop.style.display='grid'; }));
  ['dragleave','dragend','drop'].forEach(t => area.addEventListener(t, (e)=>{ e.preventDefault(); drop.style.display='none'; }));
  area.addEventListener('drop', async (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.name.toLowerCase().endsWith('.epub')) {
      const ab = await f.arrayBuffer();
      openArrayBuffer(ab);
    } else {
      setStatus('File kh√¥ng h·ª£p l·ªá. H√£y th·∫£ file .epub');
    }
  });

  // Controls
  prevBtn.addEventListener('click', ()=> rendition && rendition.prev());
  nextBtn.addEventListener('click', ()=> rendition && rendition.next());
  fontRange.addEventListener('input', applyFont);
  zoomIn.addEventListener('click', ()=>{ currentScale = Math.min(2.0, currentScale + 0.05); applyScale(); });
  zoomOut.addEventListener('click', ()=>{ currentScale = Math.max(0.6, currentScale - 0.05); applyScale(); });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if (!rendition) return;
    if (e.key === 'ArrowLeft') rendition.prev();
    if (e.key === 'ArrowRight') rendition.next();
    if (e.ctrlKey && (e.key === '+' || e.key === '=')) { currentScale = Math.min(2.0, currentScale + 0.05); applyScale(); }
    if (e.ctrlKey && e.key === '-') { currentScale = Math.max(0.6, currentScale - 0.05); applyScale(); }
  });
})();
</script>
</body>
</html>
